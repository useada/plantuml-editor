<template>
  <div class="row historyList" :style="{'height':height}">
    <div class="col-sm-12">
      <div class="alert alert-warning" v-if="!histories.length">
        点击预览中的收藏按钮，图表将会被收藏到这里。
      </div>
      <div class="thumbnail" v-for="(history, key, index) in histories" :key="index">
        <img v-lazy="createUrl(history.encodedText)" @click="read(history.text, $event)" height="200" width="100%">
        <div class="caption">
          <div class="row">
            <div class="col-sm-4">
              <button type="button" class="close pull-left" @click="del(history.id, $event)">&times;</button>
            </div>
            <div class="col-sm-8 text-right">
              <ul class="list-inline">
                <li><a :href="createUrl(history.encodedText)" target="_blank">png <i class="fa fa-external-link"></i></a></li>
                <li><a :href="createUrl(history.encodedText, 'svg')" target="_blank">svg <i class="fa fa-external-link"></i></a></li>
              </ul>
            </div>
          </div>
          <div class="row">
            <div class="col-sm-12 text-right">
              {{history.created}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
/* @flow */

export default {
  name: 'historyList',
  props: {
    height: {
      type: String,
      default: '100%'
    }
  },
  data(): any {
    return {
      deleteMessage: '从收藏中删除?',
      editMessage: '重新编辑这个图表?'
    }
  },
  computed: {
    histories(): any {
      return this.$store.state.histories.data
    }
  },
  mounted() {
    this.$store.dispatch('histories/getHistories')
    this.setLazyloadEvent()
  },
  methods: {
    createUrl(encodedText: string, extension: string = 'png'): string {
      return `${
        this.$store.state.plantumlEditor.cdn
      }${extension}/${encodedText}.${extension}`
    },
    setLazyloadEvent() {
      this.$Lazyload.$on('loaded', ({ el, naturalHeight }: any) => {
        el.height = naturalHeight
      })
    },
    del(id: number) {
      if (window.confirm(this.deleteMessage)) {
        this.$store.dispatch('histories/delete', id)
      }
    },
    read(text: string) {
      if (window.confirm(this.editMessage)) {
        this.$store.dispatch('plantumlEditor/renderUML', text)
      }
    }
  }
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
.historyList {
  margin-top: -20px;
  padding-top: 20px;
  overflow-y: auto;
  background-color: #002b36;
}
.historyList .thumbnail {
  background-color: #fffff;
  border-color: #002b36;
}
.historyList img {
  cursor: pointer;
  &[lazy='loading'] {
    background-color: #f5f5f5;
  }
  &[lazy='loaded'] {
    background-color: none;
  }
}
</style>
